# Plan: Refine check_adr_index Script Suite & State-Partitioned Index

## Summary

Two related tasks to enhance ADR (Architecture Decision Records) management:
1. **Task 1**: Refine `check_adr_index.py` to support the new YAML frontmatter format and validate ADR statuses
2. **Task 2**: Implement "State-Partitioned Index" pattern to group ADRs by status in `adr_index.md`

## Current State

- **ADR 26016** introduced YAML frontmatter with `status` field (enum: proposed, accepted, rejected, superseded, deprecated)
- **ADRs 26001-26015** use old markdown format with `## Status` section in body
- **adr_index.md** is a flat list (15 entries, missing ADR 26016)
- **check_adr_index.py** validates sync but does NOT parse status or YAML frontmatter
- **Test suite** has 47 tests, none for status validation

## Task 1: Refine check_adr_index Script Suite

### Changes to `tools/scripts/check_adr_index.py`

1. **Add YAML parsing** (requires `pyyaml` - already in pyproject.toml)
   ```python
   import yaml
   FRONTMATTER_PATTERN = re.compile(r"^---\s*\n(.*?)\n---\s*\n", re.DOTALL)
   VALID_STATUSES = {"proposed", "accepted", "rejected", "superseded", "deprecated"}
   ```

2. **Update `AdrFile` dataclass** (line 46-52)
   ```python
   @dataclass
   class AdrFile:
       path: Path
       number: int
       title: str
       status: str | None = None  # New field
   ```

3. **Add `parse_frontmatter()` function** - Extract YAML frontmatter from content

4. **Add `extract_status()` function** - Dual-format support:
   - Priority 1: YAML frontmatter `status` field (new format)
   - Priority 2: Markdown `## Status` section (old format)
   - Normalize to lowercase

5. **Update `get_adr_files()`** - Populate `status` field for each ADR

6. **Add status validation to `validate_sync()`** - New error type `invalid_status`

7. **Add title mismatch handling with interactive fix**
   - Header title is authoritative (source of truth)
   - When YAML frontmatter title differs from header:
     - In `--fix` mode: Propose auto-fix to update frontmatter
     - User confirms or rejects interactively
     - If rejected: Validation fails with error
   - New error type: `title_mismatch`
   - New function: `fix_title_mismatch(adr_file, dry_run=False)`

### Changes to `tools/tests/test_check_adr_index.py`

Add ~16 new tests:

| Test Class | Tests |
|------------|-------|
| `TestParseFrontmatter` | 3 tests: valid YAML, no frontmatter, invalid YAML |
| `TestExtractStatus` | 5 tests: from YAML, from markdown, YAML priority, no status, case normalization |
| `TestStatusValidation` | 3 tests: valid status, invalid status, parametrized enum values |
| `TestMixedFormatCoexistence` | 2 tests: discovery, validation |
| `TestTitleMismatchHandling` | 3 tests: detect mismatch, fix accepted, fix rejected |

Add helper function:
```python
def create_adr_file_with_frontmatter(directory, number, title, slug, status="proposed", tags=None)
```

## Task 2: State-Partitioned Index Pattern

### Feasibility: ✅ FEASIBLE

The pattern groups ADRs by status into three sections:
- **Active Architecture**: `accepted` status
- **Evolutionary Proposals**: `proposed` status (default for ADRs without status)
- **Historical Context**: `rejected`, `superseded`, `deprecated` statuses

### Implementation Approach

1. **Add status-to-section mapping**
   ```python
   STATUS_SECTIONS = {
       "accepted": "Active Architecture",
       "proposed": "Evolutionary Proposals",
       "rejected": "Historical Context",
       "superseded": "Historical Context",
       "deprecated": "Historical Context",
   }
   ```

2. **Partitioned index is default behavior** for `--fix` (no flag needed)

3. **Update `IndexEntry` dataclass** - Add `section: str | None` field

4. **Update `parse_index()`** - Handle multiple glossary blocks with section headers

5. **Update `fix_index()`** - Always generate partitioned index (default behavior)

6. **Add `validate_section_placement()`** - Check ADRs are in correct section based on status

### Generated Index Format

```markdown
# ADR Index

## Active Architecture

:::{glossary}
ADR 26001
: [Use of Python and OOP...](/architecture/adr/adr_26001_...)
:::

## Evolutionary Proposals

:::{glossary}
ADR 26011
: [Formalization of Script Suite...](/architecture/adr/adr_26011_...)
:::

## Historical Context

:::{glossary}
ADR 99001
: [Deprecated Feature...](/architecture/adr/adr_99001_...)
:::
```

### Additional Tests (~4 tests)

- `test_groups_by_status` - Verify section grouping
- `test_numerical_order_within_sections` - Order preserved in each section
- `test_default_section_for_no_status` - ADRs without status go to Evolutionary Proposals
- `test_validates_section_placement` - Detect ADRs in wrong section

## Implementation Sequence (TDD Approach)

**Principle: Write tests FIRST, then implement the functionality to make them pass.**

### Phase 1: Task 1 - Tests First (Script Refinement)

#### Step 1.1: Add test helper function
- Add `create_adr_file_with_frontmatter()` helper to test file

#### Step 1.2: Write tests for YAML frontmatter parsing (RED)
- `TestParseFrontmatter`: 3 tests (valid YAML, no frontmatter, invalid YAML)
- Run tests - expect failures

#### Step 1.3: Implement `parse_frontmatter()` (GREEN)
- Add YAML imports and `FRONTMATTER_PATTERN` constant
- Implement function
- Run tests - expect pass

#### Step 1.4: Write tests for status extraction (RED)
- `TestExtractStatus`: 5 tests (from YAML, from markdown, YAML priority, no status, case normalization)
- Run tests - expect failures

#### Step 1.5: Implement `extract_status()` (GREEN)
- Add `STATUS_SECTION_PATTERN` constant
- Implement function
- Run tests - expect pass

#### Step 1.6: Write tests for status validation (RED)
- `TestStatusValidation`: 3 tests (valid status, invalid status, parametrized enum)
- Run tests - expect failures

#### Step 1.7: Implement status validation (GREEN)
- Add `VALID_STATUSES` constant
- Update `AdrFile` dataclass with `status` field
- Update `get_adr_files()` to populate status
- Add status validation to `validate_sync()`
- Run tests - expect pass

#### Step 1.8: Write tests for title mismatch handling (RED)
- `TestTitleMismatchHandling`: 3 tests (detect mismatch, fix accepted, fix rejected)
- Run tests - expect failures

#### Step 1.9: Implement title mismatch handling (GREEN)
- Add `check_title_consistency()` function
- Add `fix_title_mismatch()` with user confirmation
- Run tests - expect pass

#### Step 1.10: Write tests for mixed format coexistence (RED → GREEN)
- `TestMixedFormatCoexistence`: 2 tests
- Should pass if previous steps are correct

### Phase 2: Task 2 - Tests First (Partitioned Index)

#### Step 2.1: Write tests for partitioned index generation (RED)
- `TestPartitionedIndex`: 4 tests (grouping, order within sections, default section, section validation)
- Run tests - expect failures

#### Step 2.2: Implement partitioned index (GREEN)
- Add `STATUS_SECTIONS` mapping
- Update `IndexEntry` dataclass with `section` field
- Update `parse_index()` for multi-section support
- Update `fix_index()` to generate partitioned index
- Add `validate_section_placement()` function
- Run tests - expect pass

### Phase 3: Refactor
- Review code for duplication
- Ensure all 47 existing tests still pass
- Run full test suite: `uv run pytest tools/tests/test_check_adr_index.py -v`

## Critical Files

| File | Action |
|------|--------|
| `tools/scripts/check_adr_index.py` | Modify: YAML parsing, status validation, partitioned index |
| `tools/tests/test_check_adr_index.py` | Extend: ~20 new tests |
| `architecture/adr_index.md` | Will be regenerated by `--fix` |

## Verification

1. Run existing tests (ensure no regressions): `uv run pytest tools/tests/test_check_adr_index.py`
2. Run new tests after implementation
3. Test with real ADRs: `uv run python tools/scripts/check_adr_index.py --verbose`
4. Generate partitioned index: `uv run python tools/scripts/check_adr_index.py --fix`
5. Verify ADR 26016 is now included in correct section (Active Architecture)

## Design Decisions (User Confirmed)

| Decision | Choice |
|----------|--------|
| Partitioned index | **Default behavior** for `--fix` (no flag needed) |
| Title mismatch handling | **Header is authoritative**. Auto-fix proposal in interactive mode; reject = validation failure |
| Default status | **`proposed`** for ADRs without explicit status |
