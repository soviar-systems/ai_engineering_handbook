# Plan: ADR Format Validation & Documentation

## Background & Context (IMPORTANT - Previous Implementation)

### What Was Already Implemented

The script `check_adr_index.py` was **renamed to `check_adr.py`** and significantly enhanced:

1. **YAML Frontmatter Parsing**: `parse_frontmatter()` extracts YAML from ADR files
2. **Status Validation**: Validates status against allowed values
3. **Status Typo Fixing**: Interactive fix with suggestions from `status_corrections` config
4. **Title Mismatch Detection**: Detects when frontmatter title differs from header
5. **Partitioned Index**: Groups ADRs by status into sections (Active Architecture, Evolutionary Proposals, Historical Context)
6. **SSoT Config**: `architecture/adr/adr_config.yaml` defines all valid values

### Key Design Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| SSoT for statuses | `adr_config.yaml` | Avoid data drift between template and script |
| Script rename | `check_adr_index.py` → `check_adr.py` | Script now validates more than just index |
| Partitioned index | Default behavior for `--fix` | No flag needed, always group by status |
| Title authority | Header is authoritative over frontmatter | Header is more visible, frontmatter is metadata |
| Default status | `proposed` for ADRs without explicit status | Safe default for new/legacy ADRs |
| Typo corrections | Configurable in YAML | Users/agents can add new cases as encountered |

### Current File Locations

| File | Purpose |
|------|---------|
| `tools/scripts/check_adr.py` | Main validation script (renamed) |
| `tools/tests/test_check_adr.py` | Test suite (78 tests, 96% coverage) |
| `architecture/adr/adr_config.yaml` | SSoT config for statuses, sections, typos |
| `architecture/adr/adr_template.md` | ADR template with required structure |
| `architecture/adr_index.md` | Partitioned index (regenerated) |
| `tools/docs/scripts_instructions/check_adr_py_script.md` | Script documentation (needs update) |

### Real Bug Found & Fixed

ADR 26004 had typo `Prposed` → `Proposed` (detected and fixed by the new validation)

---

## New Task: ADR Format Validation

### Problem Statement

The ADR template (`adr_template.md`) defines required structure, but `check_adr.py` only validates:
- Status values
- Title consistency
- Index synchronization

**Missing validations:**
- Required frontmatter fields (id, title, date, status, tags)
- Date format (YYYY-MM-DD)
- Valid tags from predefined list
- Required document sections (Context, Decision, Consequences, Alternatives, References, Participants)

### Template Requirements Analysis

**Frontmatter fields (from template):**
```yaml
id: ADR-YY001           # Required, format: ADR-NNNNN
title: "Short Description"  # Required
date: YYYY-MM-DD        # Required, ISO date format
status: proposed        # Required, validated ✓
superseded_by: null     # Optional
tags: [...]             # Required, from predefined list
```

**Required sections (from template):**
- `## Context`
- `## Decision`
- `## Consequences` (with `### Positive` and `### Negative / Risks`)
- `## Alternatives`
- `## References`
- `## Participants`

---

## Implementation Plan

### Task 1: Extend `adr_config.yaml` with Validation Rules

Add to `architecture/adr/adr_config.yaml`:

```yaml
# Required frontmatter fields
required_fields:
  - id
  - title
  - date
  - status
  - tags

# Date format validation
date_format: "YYYY-MM-DD"

# Valid tags (SSoT)
tags:
  - architecture
  - documentation
  - hardware
  - model
  - workflow
  - context_management
  - ci
  - governance

# Required document sections
required_sections:
  - Context
  - Decision
  - Consequences
  - Alternatives
  - References
  - Participants

# Optional subsections (warn if missing, don't fail)
recommended_subsections:
  Consequences:
    - Positive
    - "Negative / Risks"
```

### Task 2: Extend `check_adr.py` with Format Validation

#### 2.1 Add new validation functions

```python
def validate_frontmatter_fields(adr_file: AdrFile) -> list[ValidationError]:
    """Check required frontmatter fields are present."""

def validate_date_format(adr_file: AdrFile) -> list[ValidationError]:
    """Check date field matches YYYY-MM-DD format."""

def validate_tags(adr_file: AdrFile) -> list[ValidationError]:
    """Check all tags are from the allowed list."""

def validate_sections(adr_file: AdrFile) -> list[ValidationError]:
    """Check required sections are present in document body."""
```

#### 2.2 Update `AdrFile` dataclass

```python
@dataclass
class AdrFile:
    path: Path
    number: int
    title: str
    status: str | None = None
    frontmatter_title: str | None = None
    frontmatter: dict | None = None  # Store full frontmatter for validation
    content: str | None = None       # Store content for section validation
```

#### 2.3 Update `validate_sync()` to call new validators

Add new error types:
- `missing_field` - Required frontmatter field missing
- `invalid_date` - Date doesn't match YYYY-MM-DD
- `invalid_tag` - Tag not in allowed list
- `missing_section` - Required section not found

#### 2.4 Add fix functions (optional, for --fix mode)

```python
def fix_missing_field(adr_file: AdrFile, field: str) -> bool:
    """Prompt user to add missing field."""

def fix_invalid_date(adr_file: AdrFile) -> bool:
    """Prompt user to correct date format."""
```

### Task 3: Extend Test Suite

Add new test classes to `tools/tests/test_check_adr.py`:

| Test Class | Tests |
|------------|-------|
| `TestValidateFrontmatterFields` | 4 tests: all present, missing required, optional ok, no frontmatter |
| `TestValidateDateFormat` | 4 tests: valid date, invalid format, missing date, edge cases |
| `TestValidateTags` | 4 tests: all valid, invalid tag, empty tags, mixed |
| `TestValidateSections` | 5 tests: all present, missing required, partial, subsections |
| `TestMigrateLegacyAdr` | 4 tests: adds frontmatter, preserves content, extracts status, skips existing |

**Total new tests: ~21**

**Test helper update:**
```python
def create_adr_file_with_frontmatter(
    directory, number, title, slug,
    status="proposed",
    tags=None,
    frontmatter_title=None,
    date="2024-01-15",        # New
    adr_id=None,              # New
    sections=None,            # New: list of section names to include
)

def create_legacy_adr_file(
    directory, number, title, slug,
    status="Accepted",        # Old format status
    sections=None,            # Sections to include
)
```

### Task 4: Create New ADR (ADR 26017)

Create `architecture/adr/adr_26017_adr_format_validation_workflow.md`:

**Purpose:** Document the comprehensive ADR validation workflow

**Content outline:**
1. Context: Need for consistent ADR format, SSoT principle
2. Decision: Implement format validation in `check_adr.py` with config-driven rules
3. Consequences:
   - Positive: Consistency, early error detection, self-documenting config
   - Negative: Initial migration effort for non-compliant ADRs
4. Alternatives: Manual review, separate linter, schema validation
5. References: Link to adr_config.yaml, template, script docs

**This ADR itself serves as validation test** - it must pass all format checks.

### Task 5: Update Script Documentation

Update `tools/docs/scripts_instructions/check_adr_py_script.md`:

1. Update script name (was `check_adr_index.py`)
2. Document all validation types:
   - Index synchronization
   - Status validation
   - Title consistency
   - Frontmatter field validation (NEW)
   - Date format validation (NEW)
   - Tag validation (NEW)
   - Section validation (NEW)
3. Document `adr_config.yaml` structure
4. Document `--fix` mode capabilities
5. Add examples for common error messages and fixes

---

## Implementation Sequence (TDD)

### Phase 1: Config Extension
1. Update `adr_config.yaml` with new validation rules (required_fields, tags, required_sections)
2. Update test fixture `create_adr_config()` to include new fields
3. Add `create_legacy_adr_file()` test helper

### Phase 2: Tests First (RED)
1. Write `TestValidateFrontmatterFields` tests (4 tests)
2. Write `TestValidateDateFormat` tests (4 tests)
3. Write `TestValidateTags` tests (4 tests)
4. Write `TestValidateSections` tests (5 tests)
5. Write `TestMigrateLegacyAdr` tests (4 tests)
6. Run tests - expect failures

### Phase 3: Implementation (GREEN)
1. Load new config fields in `check_adr.py`
2. Implement `validate_frontmatter_fields()`
3. Implement `validate_date_format()`
4. Implement `validate_tags()`
5. Implement `validate_sections()`
6. Implement `migrate_legacy_adr()`
7. Add `--migrate` CLI flag
8. Integrate validators into `validate_sync()`
9. Run tests - expect pass

### Phase 4: Migration
1. Run `uv run python tools/scripts/check_adr.py --migrate` on legacy ADRs
2. Review generated frontmatter
3. Commit migrated ADRs

### Phase 5: Documentation
1. Create ADR 26017 (format compliant - serves as validation test)
2. Update script documentation with all new features
3. Run `check_adr.py --verbose` to validate all ADRs including ADR 26017

### Phase 6: Final Validation
1. Run full test suite: `uv run pytest tools/tests/test_check_adr.py --cov=tools.scripts.check_adr`
2. Verify coverage remains 95%+
3. Jupytext sync: `uv run jupytext --sync tools/docs/scripts_instructions/check_adr_py_script.md`

---

## Critical Files

| File | Action |
|------|--------|
| `architecture/adr/adr_config.yaml` | Extend: required_fields, tags, required_sections |
| `tools/scripts/check_adr.py` | Add: validation functions, `--migrate` flag |
| `tools/tests/test_check_adr.py` | Add: ~21 new tests, `create_legacy_adr_file()` helper |
| `architecture/adr/adr_26017_adr_format_validation_workflow.md` | Create: new ADR documenting the workflow |
| `tools/docs/scripts_instructions/check_adr_py_script.md` | Update: all validation types, `--migrate` docs |
| `architecture/adr/adr_26001_*.md` through `adr_26015_*.md` | Migrate: add YAML frontmatter via `--migrate` |

---

## Verification

```bash
# 1. Run tests with coverage
uv run pytest tools/tests/test_check_adr.py --cov=tools.scripts.check_adr --cov-report=term-missing

# 2. Migrate legacy ADRs
uv run python tools/scripts/check_adr.py --migrate

# 3. Validate all ADRs
uv run python tools/scripts/check_adr.py --verbose

# 4. Regenerate partitioned index
uv run python tools/scripts/check_adr.py --fix

# 5. Sync documentation notebook
uv run jupytext --sync tools/docs/scripts_instructions/check_adr_py_script.md
```

**Success criteria:**
- All tests pass (target: ~99 tests)
- Coverage remains 95%+
- All ADRs pass validation (including new ADR 26017)
- No validation errors from `--verbose`

---

## Design Decisions (User Confirmed)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Missing sections | **Fail validation** | Enforce consistency across all ADRs |
| Legacy ADR handling | **Auto-generate frontmatter** | New `--migrate` flag to add frontmatter to legacy ADRs |
| ID format | Allow flexibility | Accept both `26001` and `ADR-26001` formats |

---

## Additional Implementation: `--migrate` Flag

### CLI Addition

```bash
# New flag for legacy ADR migration
uv run python tools/scripts/check_adr.py --migrate
```

### Behavior

1. Scan all ADR files without YAML frontmatter
2. For each legacy ADR:
   - Extract title from `# ADR NNNNN: Title` header
   - Extract status from `## Status` section (or default to `proposed`)
   - Generate frontmatter with:
     - `id`: Derived from filename/header
     - `title`: From header
     - `date`: File modification date or prompt user
     - `status`: Extracted or `proposed`
     - `tags`: Prompt user or use empty list
     - `superseded_by`: null
3. Write updated file with frontmatter prepended
4. Report changes made

### Implementation in `check_adr.py`

```python
def migrate_legacy_adr(adr_file: AdrFile) -> bool:
    """Add YAML frontmatter to legacy ADR file."""

def main():
    parser.add_argument(
        "--migrate",
        action="store_true",
        help="Add YAML frontmatter to legacy ADRs without it",
    )
```

### Test Cases for Migration

| Test | Description |
|------|-------------|
| `test_migrate_adds_frontmatter` | Verify frontmatter is added to legacy file |
| `test_migrate_preserves_content` | Verify document body is unchanged |
| `test_migrate_extracts_status` | Verify status is extracted from ## Status section |
| `test_migrate_skips_files_with_frontmatter` | Don't modify files that already have frontmatter |
